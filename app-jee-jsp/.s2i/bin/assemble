#!/bin/bash

[ "$SCRIPT_DEBUG" = "true" ] && set -x

echo "Execute custom S2I assemble script..."

KEYCLOAK_EXAMPLE_JSON=config/keycloak-example.json
KEYCLOAL_JSON=/tmp/src/config/keycloak.json

touch $KEYCLOAL_JSON
if [ -r "/tmp/src/$KEYCLOAK_EXAMPLE_JSON" -a "$SSO_REALM" != "" -a "$SSO_SERVER_AUTH_URL" != "" -a "$SSO_SECRET" != "" ] ; then
    touch $KEYCLOAL_JSON
    echo "$KEYCLOAK_EXAMPLE_JSON found, creating $KEYCLOAL_JSON with \$SSO_SERVER_AUTH_URL=$SSO_SERVER_AUTH_URL"
    cat /tmp/src/$KEYCLOAK_EXAMPLE_JSON | \
	sed "s|\"auth-server-url\": \"http://localhost:8180/auth\"|\"auth-server-url\": \"$SSO_SERVER_AUTH_URL\"| ;
	     s|\"realm\": \"master\"|\"realm\" \"$SSO_REALM\": | ;
	     s|\"secret\": \"bce5816d-98c4-404f-a18d-bcc5cb005c79\"|\"secret\": \"$SSO_SECRET\"
	    " \
	> $KEYCLOAL_JSON
fi

echo "Execute original S2I assemble script..."
exec /usr/local/s2i/assemble
